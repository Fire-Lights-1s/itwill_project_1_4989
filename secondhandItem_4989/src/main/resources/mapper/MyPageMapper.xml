<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.itwillbs.mapper.MyPageMapper">
	<select id="getProductList" resultType="com.itwillbs.domain.ProductDTO">
		select * from Product
		where seller_id = #{seller_id}
		<if test="sale == 'pro'">
			and trade_status = '거래 가능' 
		</if>
		<if test="sale == 'com'">
			and trade_status = '거래 완료' 
		</if>
		<if test="sale == 'rsv'">
			and trade_status = '예약 중' 
		</if>
		<if test="sort == 'priceDesc'">
			order by field(trade_status, '거래 중', '예약 중', '거래 완료'), product_price desc
		</if>
		<if test="sort == 'priceAsc'">
			order by field(trade_status, '거래 중', '예약 중', '거래 완료'), product_price
		</if>
		<if test="sort == 'dateDesc'">
			order by field(trade_status, '거래 중', '예약 중', '거래 완료'), created_datetime desc
		</if>
		<if test="sort == 'dateAsc'">
			order by field(trade_status, '거래 중', '예약 중', '거래 완료'), created_datetime
		</if>
		<if test="sort == null or sort == ''">
			order by field(trade_status, '거래 중', '예약 중', '거래 완료'), created_datetime desc
		</if>
		limit #{startRow},#{pageSize}
	</select>
		
	<select id="getProductCount" resultType="java.lang.Integer">
		select count(*) from Product
		where seller_id = #{seller_id}
		<if test="sale == 'pro'">
			and trade_status = '거래 가능' 
		</if>
		<if test="sale == 'com'">
			and trade_status = '거래 완료' 
		</if>
	</select>
	
	<select id="getZzimList" resultType="com.itwillbs.domain.ProductDTO">
		select * from 
		Zzim z join Product p
		on z.product_id = p.product_id
		where z.member_id = #{seller_id}
		<if test="sort == 'priceDesc'">
			order by p.product_price desc
		</if>
		<if test="sort == 'priceAsc'">
			order by p.product_price
		</if>
		<if test="sort == 'dateDesc'">
			order by p.created_datetime desc
		</if>
		<if test="sort == 'dateAsc'">
			order by p.created_datetime
		</if>
		<if test="sort == null or sort == ''">
			order by z.zzim_id desc
		</if>
		limit #{startRow},#{pageSize}
	</select>
	
	<select id="getZzimCount" resultType="java.lang.Integer">
		select count(*) from Zzim
		where member_id = #{seller_id}
	</select>
	
	<delete id="deleteZzim">
		delete from Zzim
		where member_id = #{member_id}
		and product_id = #{product_id}
	</delete>
	
	<select id="getBuyList" resultType="com.itwillbs.domain.ProductDTO">
		select * from 
		Product p join TX t
		on p.product_id = t.product_id
		where t.buyer_id = #{seller_id}
		<if test="sale == ''">
			and t.is_reserved = true 
		</if>
		<if test="sale == 'pro'">
			and t.transaction_end_date is null
			and t.is_reserved = true
		</if>
		<if test="sale == 'com'">
			and t.transaction_end_date is not null 
		</if>
		<if test="sort == 'priceDesc'">
			order by t.is_reserved desc, t.transaction_end_date desc, p.product_price desc
		</if>
		<if test="sort == 'priceAsc'">
			order by t.is_reserved desc, t.transaction_end_date desc, p.product_price
		</if>
		<if test="sort == 'dateDesc'">
			order by t.is_reserved desc, t.transaction_end_date desc, t.reservation_date desc
		</if>
		<if test="sort == 'dateAsc'">
			order by t.is_reserved desc, t.transaction_end_date desc, t.reservation_date
		</if>
		<if test="sort == ''">
			order by t.transaction_end_date desc, t.reservation_date desc
		</if>
		limit #{startRow},#{pageSize}
	</select>
	
	<select id="getBuyCount" resultType="java.lang.Integer">
		select count(*) from TX
		where buyer_id = #{seller_id}
		<if test="sale == ''">
			and is_reserved = true
		</if>
		<if test="sale == 'pro'">
			and transaction_end_date is null
			and is_reserved = true
		</if>
		<if test="sale == 'com'">
			and transaction_end_date is not null
		</if>
	</select>
	
	<update id="deleteMem">
		update Mem
		set is_withdrawn = true, withdrawn_at = now()
		where member_id = #{member_id}
	</update>
	
	<select id="allTX" resultType="java.lang.Integer">
		SELECT 
			(SELECT COUNT(*) 
			FROM Product 
			WHERE seller_id = #{id} 
			AND trade_status = '거래 완료') 
			+
			(SELECT COUNT(*) 
			FROM TX 
			WHERE buyer_id = #{id} 
			AND transaction_end_date IS NOT NULL);
	</select>
</mapper>

